---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  // const allPosts = Object.values(import.meta.glob('../posts/*.md', { eager: true }));
  const allPosts = await getCollection("blog");

  // æ”¶é›†æ‰€æœ‰æ–‡ç« çš„æ ‡ç­¾ï¼Œå¾—åˆ°ä¸€ä¸ªä¸é‡å¤çš„æ ‡ç­¾åˆ—è¡¨ï¼Œå¹¶è¿‡æ»¤æ‰ç©ºå€¼
  const uniqueTags = [
    ...new Set(
      allPosts
        .map((post: any) => post.data.tags || [])
        .flat()
        .filter((tag: any) => tag && tag.trim() !== "")
    ),
  ];

  // ä¸ºæ¯ä¸ªæ ‡ç­¾ç”Ÿæˆä¸€ä¸ªé™æ€è·¯å¾„
  return uniqueTags.map((tag) => {
    const filteredPosts = allPosts.filter(
      (post: any) => post.data.tags && post.data.tags.includes(tag)
    );
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---
<BaseLayout pageTitle={tag}>
  <div class="space-y-8 mt-6">
    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <div class="mb-10">
      <div class="flex items-center gap-3 mb-4">
        <a href={`${import.meta.env.BASE_URL}tags/`} class="text-blue-500 hover:text-blue-700 text-sm font-medium">â† è¿”å›æ ‡ç­¾åˆ—è¡¨</a>
      </div>
      
      <h1 
        class="text-4xl md:text-5xl font-bold mb-4"
      >
        ğŸ·ï¸ 
        <span
          style="background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 50%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; display: inline-block;"
        >
          {tag}
        </span>
      </h1>
      
      <p class="text-gray-600 text-lg mt-4">
        å…±æœ‰ <span class="font-bold text-blue-600">{posts.length}</span> ç¯‡æ–‡ç« 
      </p>
    </div>

    <!-- æ–‡ç« åˆ—è¡¨ -->
    <div class="space-y-3">
      {posts.length > 0 ? (
        <ul class="space-y-2" style="padding: 0; list-style: none;">
          {posts.map((post: any) => (
            <li class="list-none">
              <a 
                href={`${import.meta.env.BASE_URL}posts/${post.id}/`}
                class="
                  block p-4 rounded-lg
                  bg-linear-to-r from-blue-50 to-indigo-50
                  hover:from-blue-100 hover:to-indigo-100
                  border border-blue-200 hover:border-blue-400
                  transition-all duration-300
                  hover:shadow-md hover:scale-[1.02]
                  group
                "
              >
                <div class="flex items-start justify-between gap-4">
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-gray-800 group-hover:text-blue-600 transition-colors truncate">
                      {post.data.title}
                    </h3>
                    {post.data.description && (
                      <p class="text-sm text-gray-600 mt-1 line-clamp-1">
                        {post.data.description}
                      </p>
                    )}
                  </div>
                  <span class="text-xs text-gray-500 whitespace-nowrap mt-1">
                    {post.data.pubDate?.toLocaleDateString('zh-CN')}
                  </span>
                </div>
              </a>
            </li>
          ))}
        </ul>
      ) : (
        <div class="text-center py-12">
          <p class="text-gray-500 text-lg">è¿˜æ²¡æœ‰æ­¤æ ‡ç­¾çš„æ–‡ç« </p>
        </div>
      )}
    </div>
  </div>
</BaseLayout>