---
import BaseLayout from '../layouts/BaseLayout.astro';
import '../styles/global.css';
import "../styles/markdown.css"
const { frontmatter, headings } = Astro.props;
---
<meta charset="utf-8" />
<BaseLayout >
  <div class="max-w-[1400px] mx-auto px-8 md:px-4">
    <div class="flex gap-8 items-start">
      <!-- ä¸»è¦å†…å®¹åŒº -->
      <article class="markdown-body flex-1 min-w-0 max-w-[800px]">
        <h1 class="bg-gradient-to-r from-purple-600 via-violet-600 to-blue-600 bg-clip-text text-transparent">{frontmatter.title}</h1>
        <p>ä½œè€…ï¼š{frontmatter.author}ï¼Œå‘è¡¨äºï¼š{frontmatter.pubDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
        <p><em>{frontmatter.description}</em></p>
        <div class="flex flex-wrap">
          {frontmatter.tags.map((tag: any) => (
            <span class="m-1 border border-dotted border-gray-400 rounded-lg px-4 py-2 text-lg bg-blue-50 dark:bg-gray-800">
                <a href={`/tags/${tag}/`} class="text-blue-700 dark:text-blue-400">{tag}</a>
            </span>
          ))}
        </div>

        <img src={frontmatter.image.url}  alt={frontmatter.image.alt} />
        <slot />
      </article>

      <!-- æ–‡æ¡£å¤§çº²ï¼ˆç›®å½•ï¼‰- å³ä¾§ -->
      <aside class="toc-sidebar hidden xl:block sticky top-24 w-64 shrink-0 max-h-[calc(100vh-8rem)] overflow-y-auto">
        <div class="bg-transparent">
          <h3 class="text-sm font-semibold mb-4 text-gray-600 dark:text-gray-400 pb-2 border-b border-gray-200 dark:border-gray-700">ğŸ“– ç›®å½•</h3>
          <nav>
            {headings && headings.length > 0 ? (
              <ul class="list-none p-0 m-0">
                {headings.map((heading: any) => (
                  <li class={`my-1 ${
                    heading.depth === 1 ? '' :
                    heading.depth === 2 ? 'pl-5' :
                    heading.depth === 3 ? 'pl-8' :
                    heading.depth === 4 ? 'pl-11' :
                    'pl-14'
                  }`}>
                    <a 
                      href={`#${heading.slug}`} 
                      class={`toc-link block py-1.5 px-3 rounded-md transition-all duration-150 text-sm leading-tight border-l-2 border-transparent no-underline
                        ${heading.depth === 1 ? 'font-medium text-gray-800 dark:text-gray-200' : 'text-gray-600 dark:text-gray-400'}
                        ${heading.depth >= 3 ? 'text-[13px]' : ''}
                        ${heading.depth >= 5 ? 'text-xs opacity-70' : ''}
                        hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-blue-600 dark:hover:text-blue-400 hover:border-l-blue-600 dark:hover:border-l-blue-400
                      `}
                    >
                      {heading.text}
                    </a>
                  </li>
                ))}
              </ul>
            ) : (
              <p class="text-gray-500 dark:text-gray-500 text-sm my-8">æš‚æ— ç›®å½•</p>
            )}
          </nav>
        </div>
      </aside>
    </div>
  </div>
</BaseLayout>

<style>
  /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
  .toc-sidebar::-webkit-scrollbar {
    width: 4px;
  }

  .toc-sidebar::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc-sidebar::-webkit-scrollbar-thumb {
    background: #d0d7de;
    border-radius: 2px;
  }

  .toc-sidebar::-webkit-scrollbar-thumb:hover {
    background: #8b949e;
  }

  @media (prefers-color-scheme: dark) {
    .toc-sidebar::-webkit-scrollbar-thumb {
      background: #30363d;
    }

    .toc-sidebar::-webkit-scrollbar-thumb:hover {
      background: #484f58;
    }
  }
</style>

<script>
  // ç›®å½•å½“å‰é¡¹é«˜äº®
  document.addEventListener('DOMContentLoaded', () => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.getAttribute('id');
          const tocLink = document.querySelector(`.toc-link[href="#${id}"]`);
          
          if (entry.isIntersecting) {
            // ç§»é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.toc-link').forEach((link) => {
              const htmlLink = link as HTMLElement;
              htmlLink.style.background = '';
              htmlLink.style.color = '';
              htmlLink.style.fontWeight = '';
              htmlLink.style.borderLeftColor = '';
            });
            
            // æ·»åŠ å½“å‰é«˜äº®
            if (tocLink) {
              const htmlTocLink = tocLink as HTMLElement;
              const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
              htmlTocLink.style.color = isDark ? '#58a6ff' : '#0969da';
              htmlTocLink.style.fontWeight = '600';
              htmlTocLink.style.borderLeftColor = isDark ? '#58a6ff' : '#0969da';
            }
          }
        });
      },
      {
        rootMargin: '-80px 0px -66%',
        threshold: 1.0,
      }
    );

    // è§‚å¯Ÿæ‰€æœ‰æ ‡é¢˜
    document.querySelectorAll('article h1[id], article h2[id], article h3[id], article h4[id], article h5[id], article h6[id]').forEach((heading) => {
      observer.observe(heading);
    });

    // å¹³æ»‘æ»šåŠ¨
    document.querySelectorAll('.toc-link').forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href')?.slice(1);
        const targetElement = document.getElementById(targetId || '');
        
        if (targetElement) {
          // è®¡ç®—ç›®æ ‡ä½ç½®ï¼Œå‡å» header é«˜åº¦å’Œé¢å¤–è¾¹è·
          const headerOffset = 100; // æ ¹æ®ä½ çš„ header é«˜åº¦è°ƒæ•´
          const elementPosition = targetElement.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

          window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
          });
          
          // æ›´æ–° URL
          history.pushState(null, '', `#${targetId}`);
        }
      });
    });
  });
</script>