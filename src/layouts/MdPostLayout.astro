---
import BaseLayout from '../layouts/BaseLayout.astro';
import PlaygroundDrawer from '../components/PlaygroundDrawer.astro';
import '../styles/global.css';
import "../styles/markdown.css"
const { frontmatter, headings } = Astro.props;
---
<meta charset="utf-8" />
<BaseLayout >
  <div class="max-w-350 mx-auto px-8 md:px-4">
    <div class="flex gap-8 items-start">
      <!-- ä¸»è¦å†…å®¹åŒº -->
      <article class="markdown-body flex-1 min-w-0 max-w-200">
        <h1 class="bg-linear-to-r from-purple-600 via-violet-600 to-blue-600 bg-clip-text text-transparent">{frontmatter.title}</h1>
        <p>ä½œè€…ï¼š{frontmatter.author}ï¼Œå‘è¡¨äºï¼š{frontmatter.pubDate.toLocaleTimeString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
        <p><em>{frontmatter.description}</em></p>
        <div class="flex flex-wrap">
          {frontmatter.tags.map((tag: any) => (
            <span class="m-1 border border-dotted border-gray-400 rounded-lg px-4 py-2 text-lg bg-blue-50 dark:bg-gray-800">
                <a href={`${import.meta.env.BASE_URL}tags/${tag}/`} class="text-blue-700 dark:text-blue-400">{tag}</a>
            </span>
          ))}
        </div>

        <img src={frontmatter.image.url}  alt={frontmatter.image.alt} />
        <slot />
      </article>

      <!-- æ–‡æ¡£å¤§çº²ï¼ˆç›®å½•ï¼‰- å³ä¾§ -->
      <aside class="toc-sidebar hidden xl:block sticky top-24 w-64 shrink-0 max-h-[calc(100vh-8rem)] overflow-y-auto">
        <div class="bg-transparent">
          <h3 class="text-sm font-semibold mb-4 text-gray-600 dark:text-gray-400 pb-2 border-b border-gray-200 dark:border-gray-700">ğŸ“– ç›®å½•</h3>
          <nav>
            {headings && headings.length > 0 ? (
              <ul class="list-none p-0 m-0">
                {headings.map((heading: any) => (
                  <li class={`my-1 ${
                    heading.depth === 1 ? '' :
                    heading.depth === 2 ? 'pl-5' :
                    heading.depth === 3 ? 'pl-8' :
                    heading.depth === 4 ? 'pl-11' :
                    'pl-14'
                  }`}>
                    <a 
                      href={`#${heading.slug}`} 
                      class={`toc-link block py-1.5 px-3 rounded-md transition-all duration-150 text-sm leading-tight border-l-2 border-transparent no-underline
                        ${heading.depth === 1 ? 'font-medium text-gray-800 dark:text-gray-200' : 'text-gray-600 dark:text-gray-400'}
                        ${heading.depth >= 3 ? 'text-[13px]' : ''}
                        ${heading.depth >= 5 ? 'text-xs opacity-70' : ''}
                        hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-blue-600 dark:hover:text-blue-400 hover:border-l-blue-600 dark:hover:border-l-blue-400
                      `}
                    >
                      {heading.text}
                    </a>
                  </li>
                ))}
              </ul>
            ) : (
              <p class="text-gray-500 dark:text-gray-500 text-sm my-8">æš‚æ— ç›®å½•</p>
            )}
          </nav>
        </div>
      </aside>
    </div>
  </div>

  <button 
    class="fixed z-50 bottom-8 right-28 w-12 h-12 p-3 flex items-center justify-center rounded-full shadow-lg bg-linear-to-br from-pink-400 via-violet-500 to-blue-500 text-white text-2xl hover:scale-110 transition-transform duration-200"
    style="box-shadow:0 4px 24px 0 rgba(139,92,246,0.18);"
    onclick="window.openPlaygroundDrawer()"
    title="ä»£ç ç»ƒå…µåœº"
  >
    ğŸ’»
  </button>


  <PlaygroundDrawer />
</BaseLayout>

<style>
  /* ç›®å½•å­—ä½“ */
  .toc-sidebar,
  .toc-sidebar * {
    font-family:
      "Noto Serif SC",
      "Source Serif Pro",
      -apple-system,
      BlinkMacSystemFont,
      "Segoe UI",
      "PingFang SC",
      "Hiragino Sans GB",
      "Microsoft YaHei",
      serif,
      sans-serif;
  }

  /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
  .toc-sidebar::-webkit-scrollbar {
    width: 4px;
  }

  .toc-sidebar::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc-sidebar::-webkit-scrollbar-thumb {
    background: #d0d7de;
    border-radius: 2px;
  }

  .toc-sidebar::-webkit-scrollbar-thumb:hover {
    background: #8b949e;
  }

  @media (prefers-color-scheme: dark) {
    .toc-sidebar::-webkit-scrollbar-thumb {
      background: #30363d;
    }

    .toc-sidebar::-webkit-scrollbar-thumb:hover {
      background: #484f58;
    }
  }
</style>

<script>
  // ç›®å½•å½“å‰é¡¹é«˜äº® + è‡ªåŠ¨æ»šåŠ¨è·Ÿéš
  document.addEventListener('DOMContentLoaded', () => {
    const tocSidebar = document.querySelector('.toc-sidebar') as HTMLElement;
    
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.getAttribute('id');
          const tocLink = document.querySelector(`.toc-link[href="#${id}"]`) as HTMLElement;
          
          if (entry.isIntersecting) {
            // ç§»é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.toc-link').forEach((link) => {
              const htmlLink = link as HTMLElement;
              htmlLink.style.background = '';
              htmlLink.style.color = '';
              htmlLink.style.fontWeight = '';
              htmlLink.style.borderLeftColor = '';
            });
            
            // æ·»åŠ å½“å‰é«˜äº®
            if (tocLink) {
              const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
              tocLink.style.color = isDark ? '#58a6ff' : '#0969da';
              tocLink.style.background = isDark ? '#1e293b' : '#e0f2fe';
              tocLink.style.fontWeight = '600';
              tocLink.style.borderLeftColor = isDark ? '#58a6ff' : '#0969da';
              
              // ç›®å½•è‡ªåŠ¨æ»šåŠ¨åˆ°å½“å‰é¡¹
              if (tocSidebar) {
                const linkRect = tocLink.getBoundingClientRect();
                const sidebarRect = tocSidebar.getBoundingClientRect();
                const relativeTop = tocLink.offsetTop - tocSidebar.scrollTop;
                
                // å¦‚æœå½“å‰é¡¹ä¸åœ¨å¯è§åŒºåŸŸï¼Œåˆ™æ»šåŠ¨åˆ°ä¸­é—´
                if (relativeTop < 50) {
                  tocSidebar.scrollTop = tocLink.offsetTop - 100;
                } else if (relativeTop + tocLink.offsetHeight > sidebarRect.height - 50) {
                  tocSidebar.scrollTop = tocLink.offsetTop - sidebarRect.height + tocLink.offsetHeight + 100;
                }
              }
            }
          }
        });
      },
      {
        rootMargin: '-80px 0px -66%',
        threshold: 1.0,
      }
    );

    // è§‚å¯Ÿæ‰€æœ‰æ ‡é¢˜
    document.querySelectorAll('article h1[id], article h2[id], article h3[id], article h4[id], article h5[id], article h6[id]').forEach((heading) => {
      observer.observe(heading);
    });

    // å¹³æ»‘æ»šåŠ¨
    document.querySelectorAll('.toc-link').forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href')?.slice(1);
        const targetElement = document.getElementById(targetId || '');
        
        if (targetElement) {
          // è®¡ç®—ç›®æ ‡ä½ç½®ï¼Œå‡å» header é«˜åº¦å’Œé¢å¤–è¾¹è·
          const headerOffset = 100; // æ ¹æ®ä½ çš„ header é«˜åº¦è°ƒæ•´
          const elementPosition = targetElement.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

          window.scrollTo({
            top: offsetPosition,
            behavior: 'instant'
          });
          
          // æ›´æ–° URL
          history.pushState(null, '', `#${targetId}`);
        }
      });
    });
  });
</script>